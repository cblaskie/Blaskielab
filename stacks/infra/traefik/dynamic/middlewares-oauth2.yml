http:
  routers:
    # Router for auth.theblaskies.com
    oauth2-proxy-router:
      rule: "Host(`auth.theblaskies.com`) && PathPrefix(`/oauth2`)"
      service: oauth2-proxy-service
      entryPoints:
        - websecure
      tls:
        certResolver: cloudflare

    # Router for logout
    logout-router:
      rule: "Host(`auth.theblaskies.com`) && Path(`/logout`)"
      service: oauth2-proxy-service
      middlewares:
        - oauth2-logout
      entryPoints:
        - websecure
      tls:
        certResolver: cloudflare

  services:
    # THIS SECTION FIXES THE "SERVICE DOES NOT EXIST" ERROR
    oauth2-proxy-service:
      loadBalancer:
        servers:
          - url: "http://oauth2-proxy:4180"

  middlewares:
    # v3 Logic: Chain Verify + Signin
    oauth2-auth:
      chain:
        middlewares:
          - oauth-signin
          - oauth-verify

    oauth-signin:
      errors:
        status:
          - "401"
        # 1. We change /sign_in to /start to skip the manual button.
        # 2. We use {url} to ensure the destination is preserved.
        query: "/oauth2/start?rd={url}"
        service: oauth2-proxy-service
    oauth-verify:
      forwardAuth:
        address: "http://oauth2-proxy:4180/oauth2/auth"
        trustForwardHeader: true
        authRequestHeaders:
          - "X-Forwarded-Host"
          - "X-Forwarded-Proto"
          - "X-Forwarded-Method"
          - "X-Forwarded-Uri"
          - "X-Forwarded-For"
        authResponseHeaders:
          - "X-Auth-Request-User"
          - "X-Auth-Request-Email"
          - "X-Auth-Request-Groups"
          - "Set-Cookie"
    oauth2-logout:
      redirectRegex:
        regex: "^https://auth.theblaskies.com/logout$"
        replacement: "https://auth.theblaskies.com/oauth2/sign_out?rd=https://home.theblaskies.com"
