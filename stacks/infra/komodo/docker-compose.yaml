services:
  komodo-core:
    image: ghcr.io/moghtech/komodo-core@sha256:a1cceb4f971443b1e9f2a767788f663d0afb6244ee2135f7fe3fd1036af37ade
    container_name: komodo-core
    restart: unless-stopped

    env_file:
      - .env

    ports:
      # Optional: keep for LAN access during bootstrap
      - "9120:9120"

    volumes:
      # Optional: database backups
      - /mnt/user/appdata/komodo/backups:/backups
      - /mnt/user/appdata/komodo:/data

    networks:
      - infra_net
      - proxy_net

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.komodo.rule=Host(`komodo.theblaskies.com`)"
      - "traefik.http.routers.komodo.entrypoints=websecure"
      - "traefik.http.routers.komodo.tls=true"
      - "traefik.http.routers.komodo.priority=50"

  # Service (CRITICAL)
      - "traefik.http.services.komodo.loadbalancer.server.port=9120"
      - "traefik.http.services.komodo.loadbalancer.server.scheme=http"

  # Headers middleware (OK)
      - "traefik.http.middlewares.komodo-headers.headers.customrequestheaders.X-Forwarded-Host=komodo.theblaskies.com"
      - "traefik.http.middlewares.komodo-headers.headers.customrequestheaders.X-Forwarded-Proto=https"

  # Apply middleware
      - "traefik.http.routers.komodo.middlewares=komodo-headers"
  komodo-periphery:
    image: ghcr.io/moghtech/komodo-periphery@sha256:bd79cf960ed054fe8e02384322303e462448679b1149dde48bbef151417255b1
    container_name: komodo-periphery
    restart: unless-stopped

    env_file:
      - .env

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /proc:/proc
      # FIX: Mount your appdata to the expected root and the repo-cache specifically
      - /mnt/user/appdata/komodo:/etc/komodo
      - /mnt/user/appdata/komodo/repo-cache:/repo-cache
      - /mnt/user/appdata/traefik:/mnt/user/appdata/traefik
    networks:
      - infra_net


networks:
  infra_net:
    external: true
  proxy_net:
    external: true
