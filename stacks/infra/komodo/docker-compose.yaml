services:
  komodo-core:
    image: ghcr.io/moghtech/komodo-core@sha256:a1cceb4f971443b1e9f2a767788f663d0afb6244ee2135f7fe3fd1036af37ade
    container_name: komodo-core
    restart: unless-stopped

    env_file:
      - .env

    ports:
      # Optional: keep for LAN access during bootstrap
      - "9120:9120"

    volumes:
      # Optional: database backups
      - /mnt/user/appdata/komodo/backups:/backups
      - ./core.config.toml:/config/core.config.toml
      - /mnt/user/appdata/komodo:/data

    networks:
      - infra_net
      - proxy_net

    labels:
      - traefik.enable=true
      - traefik.http.routers.komodo.rule=Host(`komodo.theblaskies.com`)
      - traefik.http.routers.komodo.entrypoints=websecure
      - traefik.http.routers.komodo.tls=true
      - traefik.http.services.komodo.loadbalancer.server.port=9120
      - traefik.http.routers.komodo.priority=50

     # Optional later:
      # - traefik.http.routers.komodo.middlewares=auth@file

  komodo-periphery:
    image: ghcr.io/moghtech/komodo-periphery@sha256:bd79cf960ed054fe8e02384322303e462448679b1149dde48bbef151417255b1
    container_name: komodo-periphery
    restart: unless-stopped

    env_file:
      - .env

    volumes:
      # Docker control
      - /var/run/docker.sock:/var/run/docker.sock

      # Required for process inspection
      - /proc:/proc

      # Must be identical inside and outside container
      - ${PERIPHERY_ROOT_DIRECTORY:-/etc/komodo}:${PERIPHERY_ROOT_DIRECTORY:-/etc/komodo}
      # Config for Periphery
      #- ./periphery.config.toml:/etc/komodo/periphery.config.toml
      - /mnt/user/appdata/traefik:/mnt/user/appdata/traefik
      - /mnt/user/appdata/komodo:/etc/komodo
    networks:
      - infra_net


networks:
  infra_net:
    external: true
  proxy_net:
    external: true
