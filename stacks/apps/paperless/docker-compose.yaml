name: paperless

services:
  paperless-redis:
    image: redis:7
    container_name: paperless-redis
    restart: unless-stopped
    command: redis-server --save "" --appendonly no
    networks:
      - infra_net

  paperless-gotenberg:
    image: gotenberg/gotenberg:8
    container_name: paperless-gotenberg
    restart: unless-stopped
    command:
      - gotenberg
      - --chromium-disable-javascript=true
      - --chromium-allow-list=file:///tmp/.*
    networks:
      - infra_net

  paperless-tika:
    image: apache/tika:3.2.3.0-full
    container_name: paperless-tika
    restart: unless-stopped
    networks:
      - infra_net

  # ðŸ§  GPU-accelerated router / converter
    paperless-router:
    image: nvidia/cuda:12.3.2-runtime-ubuntu22.04
    container_name: paperless-router
    restart: unless-stopped

    environment:
      NVIDIA_VISIBLE_DEVICES: all
      NVIDIA_DRIVER_CAPABILITIES: compute,utility

    volumes:
      - /mnt/user/data/paperless/drop:/drop
      - /mnt/user/data/paperless/consume:/consume
      - /mnt/user/data/paperless/failed:/failed

    entrypoint: ["/bin/bash", "-c"]
    command: |
      apt-get update && \
      apt-get install -y imagemagick inotify-tools libheif1 && \
      echo "Paperless router started" && \
      inotifywait -m -e close_write --format '%f' /drop | while read FILE; do
        SRC="/drop/$$FILE"
        EXT="$${FILE##*.}"
        BASENAME="$${FILE%.*}"

        case "$${EXT,,}" in
          heic)
            echo "HEIC â†’ PDF: $$FILE"
            magick "$$SRC" -density 300 -quality 95 "/consume/$$BASENAME.pdf" \
              && rm "$$SRC" \
              || mv "$$SRC" /failed/
            ;;
          jpg|jpeg|png|tiff)
            echo "Image â†’ PDF: $$FILE"
            magick "$$SRC" -density 300 "/consume/$$BASENAME.pdf" \
              && rm "$$SRC"
            ;;
          pdf)
            echo "PDF passthrough: $$FILE"
            mv "$$SRC" /consume/
            ;;
          *)
            echo "Unsupported file: $$FILE"
            mv "$$SRC" /failed/
            ;;
        esac
      done

    networks:
      - infra_net

    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]

  paperless:
    image: ghcr.io/paperless-ngx/paperless-ngx:latest
    container_name: paperless
    restart: unless-stopped

    env_file:
      - .env

    environment:
      PAPERLESS_URL: ${PAPERLESS_URL}
      PAPERLESS_TIKA_ENABLED: "1"
      PAPERLESS_TIKA_ENDPOINT: http://paperless-tika:9998
      PAPERLESS_GOTENBERG_ENDPOINT: http://paperless-gotenberg:3000

    volumes:
      - /mnt/user/data/paperless/data:/usr/src/paperless/data
      - /mnt/user/data/paperless/media:/usr/src/paperless/media
      - /mnt/user/data/paperless/export:/usr/src/paperless/export
      - /mnt/user/data/paperless/consume:/usr/src/paperless/consume

    networks:
      - infra_net
      - proxy_net

    labels:
      - traefik.enable=true
      - traefik.http.routers.paperless.rule=Host(`paperless.theblaskies.com`)
      - traefik.http.routers.paperless.entrypoints=websecure
      - traefik.http.routers.paperless.tls=true
      - traefik.http.routers.paperless.tls.certresolver=cloudflare
      - traefik.http.services.paperless.loadbalancer.server.port=8000
      - traefik.http.middlewares.paperless-headers.headers.customrequestheaders.X-Forwarded-Proto=https
      - traefik.http.middlewares.paperless-headers.headers.customrequestheaders.X-Forwarded-Host=paperless.theblaskies.com
      - traefik.http.routers.paperless.middlewares=paperless-headers

  paperless-gpt:
    image: ghcr.io/icereed/paperless-gpt:latest
    container_name: paperless-gpt
    restart: unless-stopped

    env_file:
      - .env

    environment:
      PAPERLESS_URL: https://paperless.theblaskies.com
      PAPERLESS_API_TOKEN: ${PAPERLESS_API_TOKEN}
      LLM_PROVIDER: ollama
      LLM_MODEL: ${LLM_MODEL}
      OLLAMA_BASE_URL: http://ollama:11434

    volumes:
      - /mnt/user/appdata/paperless-gpt:/data

    networks:
      - infra_net

    depends_on:
      - paperless

networks:
  infra_net:
    external: true
  proxy_net:
    external: true
