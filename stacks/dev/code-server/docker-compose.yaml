services:
  code-server:
    image: ghcr.io/coder/code-server:latest@sha256:867b9a9dedd68f1b46e308cad9525e419db7b0ce0c83831f6a350f37ee7ff6fd
    container_name: code-server
    restart: unless-stopped

    user: "0:0"
    working_dir: /mnt

    environment:
      TZ: ${TZ}
      AUTH: none
      DOCKER_HOST: tcp://docker-socket-proxy:2375

    entrypoint: /entrypoint.sh

    volumes:
      # Entrypoint script
      - /mnt/user/appdata/code-server/entrypoint.sh:/entrypoint.sh:ro

      # code-server config/state
      - /mnt/user/appdata/code-server/config:/home/coder/.config

      # extensions list (plain text)
      - /mnt/user/appdata/code-server/extensions/extensions.json:/home/coder/extensions.json:ro

      # Git working directory
      - /mnt/user/repos:/mnt/repos

      # FULL appdata access (intentional)
      - /mnt/user/appdata:/mnt/appdata-config

    networks:
      - proxy_net

    labels:
      - traefik.enable=true
      - traefik.http.routers.code.rule=Host(`code.theblaskies.com`)
      - traefik.http.routers.code.entrypoints=websecure
      - traefik.http.routers.code.tls=true
      - traefik.http.services.code.loadbalancer.server.port=8080

networks:
  proxy_net:
    external: true
