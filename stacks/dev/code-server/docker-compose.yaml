services:
  code-server:
    image: ghcr.io/coder/code-server:latest
    container_name: code-server
    restart: unless-stopped

    # Root is intentional since you're editing appdata
    user: "0:0"

    # So you see both repos + appdata easily
    working_dir: /mnt

    environment:
      TZ: ${TZ}
      AUTH: none

    entrypoint: ["/bin/sh", "-c"]

    command: |
      if [ -f /home/coder/extensions.json ]; then
        xargs -n 1 code-server --install-extension < /home/coder/extensions.json
      fi
      exec code-server --bind-addr 0.0.0.0:8080 --disable-telemetry

    volumes:
      # 1. code-server config/state
      - /mnt/user/appdata/code-server/config:/home/coder/.config

      # 2. extensions list (SOURCE OF TRUTH)
      - /mnt/user/appdata/code-server/extensions/extensions.json:/home/coder/extensions.json:ro

      # 3. Git working directory
      - /mnt/user/repos:/mnt/repos

      # 4. FULL appdata access (intentional, blunt method)
      - /mnt/user/appdata:/mnt/appdata-config

    networks:
      - proxy_net

    labels:
      - traefik.enable=true
      - traefik.http.routers.code.rule=Host(`code.theblaskies.com`)
      - traefik.http.routers.code.entrypoints=websecure
      - traefik.http.routers.code.tls=true
      - traefik.http.routers.code.middlewares=authentik@file,secure-headers@file
      - traefik.http.services.code.loadbalancer.server.port=8080

networks:
  proxy_net:
    external: true
